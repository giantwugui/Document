
<!-- saved from url=(0328)https://app.yinxiang.com/Home.action?_sourcePage=wX5ozTb3cQPiMUD9T65RG_YvRLZ-1eYO3fqfqRu0fynRL_1nukNa4gH1t86pc1SP&__fp=F1lH3xQ_XIs3yWPvuidLz-TPR6I9Jhx8&hpts=1540196895208&showSwitchService=true&usernameImmutable=false&login=&login=%E7%99%BB%E5%BD%95&login=true&username=1375400884%40qq.com&hptsh=E2nvTcdUN5ROs%2FdtRHCEbKEERfs%3D -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style type="text/css">@font-face{font-family:caecilia;src:url(/redesign/global/css/fonts/caecilialtstd-light-webfont.eot?#iefix) format("embedded-opentype"), url(/redesign/global/css/fonts/caecilialtstd-light-webfont.woff) format("woff"), url(/redesign/global/css/fonts/caecilialtstd-light-webfont.ttf) format("truetype"), url(/redesign/global/css/fonts/caecilialtstd-light-webfont.svg#webfont_bold) format("svg");font-weight:300;font-style:normal;}@font-face{font-family:caecilia-300-normal;src:url(/redesign/global/css/fonts/caecilialtstd-light-webfont.eot);src:url(/redesign/global/css/fonts/caecilialtstd-light-webfont.eot?#iefix) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:caecilia;src:url(/redesign/global/css/fonts/caecilialtstd-lightitalic-webfont.eot?#iefix) format("embedded-opentype"), url(/redesign/global/css/fonts/caecilialtstd-lightitalic-webfont.woff) format("woff"), url(/redesign/global/css/fonts/caecilialtstd-lightitalic-webfont.ttf) format("truetype"), url(/redesign/global/css/fonts/caecilialtstd-lightitalic-webfont.svg#webfont_bold) format("svg");font-weight:300;font-style:italic;}@font-face{font-family:caecilia-300-italic;src:url(/redesign/global/css/fonts/caecilialtstd-lightitalic-webfont.eot);src:url(/redesign/global/css/fonts/caecilialtstd-lightitalic-webfont.eot?#iefix) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:caecilia;src:url(/redesign/global/css/fonts/caecilialtstd-roman-webfont.eot?#iefix) format("embedded-opentype"), url(/redesign/global/css/fonts/caecilialtstd-roman-webfont.woff) format("woff"), url(/redesign/global/css/fonts/caecilialtstd-roman-webfont.ttf) format("truetype"), url(/redesign/global/css/fonts/caecilialtstd-roman-webfont.svg#webfont_bold) format("svg");font-weight:400;font-style:normal;}@font-face{font-family:caecilia-400-normal;src:url(/redesign/global/css/fonts/caecilialtstd-roman-webfont.eot);src:url(/redesign/global/css/fonts/caecilialtstd-roman-webfont.eot?#iefix) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:caecilia;src:url(/redesign/global/css/fonts/caecilialtstd-italic-webfont.eot?#iefix) format("embedded-opentype"), url(/redesign/global/css/fonts/caecilialtstd-italic-webfont.woff) format("woff"), url(/redesign/global/css/fonts/caecilialtstd-italic-webfont.ttf) format("truetype"), url(/redesign/global/css/fonts/caecilialtstd-italic-webfont.svg#webfont_bold) format("svg");font-weight:400;font-style:italic;}@font-face{font-family:caecilia-400-italic;src:url(/redesign/global/css/fonts/caecilialtstd-italic-webfont.eot);src:url(/redesign/global/css/fonts/caecilialtstd-italic-webfont.eot?#iefix) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:caecilia;src:url(/redesign/global/css/fonts/caecilialtstd-bold-webfont.eot?#iefix) format("embedded-opentype"), url(/redesign/global/css/fonts/caecilialtstd-bold-webfont.woff) format("woff"), url(/redesign/global/css/fonts/caecilialtstd-bold-webfont.ttf) format("truetype"), url(/redesign/global/css/fonts/caecilialtstd-bold-webfont.svg#webfont_bold) format("svg");font-weight:700;font-style:normal;}@font-face{font-family:caecilia-700-normal;src:url(/redesign/global/css/fonts/caecilialtstd-bold-webfont.eot);src:url(/redesign/global/css/fonts/caecilialtstd-bold-webfont.eot?#iefix) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:caecilia;src:url(/redesign/global/css/fonts/caecilialtstd-bolditalic-webfont.eot?#iefix) format("embedded-opentype"), url(/redesign/global/css/fonts/caecilialtstd-bolditalic-webfont.woff) format("woff"), url(/redesign/global/css/fonts/caecilialtstd-bolditalic-webfont.ttf) format("truetype"), url(/redesign/global/css/fonts/caecilialtstd-bolditalic-webfont.svg#webfont_bold) format("svg");font-weight:700;font-style:italic;}@font-face{font-family:caecilia-700-italic;src:url(/redesign/global/css/fonts/caecilialtstd-bolditalic-webfont.eot);src:url(/redesign/global/css/fonts/caecilialtstd-bolditalic-webfont.eot?#iefix) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:evernote_rhonda;src:url(/redesign/global/css/fonts/evernoterhonda-regular-webfont.eot?#iefix) format("embedded-opentype"), url(/redesign/global/css/fonts/evernoterhonda-regular-webfont.woff) format("woff"), url(/redesign/global/css/fonts/evernoterhonda-regular-webfont.ttf) format("truetype"), url(/redesign/global/css/fonts/evernoterhonda-regular-webfont.svg#webfont_bold) format("svg");font-weight:normal;font-style:normal;}@font-face{font-family:evernote_rhonda-normal-normal;src:url(/redesign/global/css/fonts/evernoterhonda-regular-webfont.eot);src:url(/redesign/global/css/fonts/evernoterhonda-regular-webfont.eot?#iefix) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:gotham;src:local("?"), url(/redesign/global/css/fonts/04F6D068D4A33A1DF.eot?#hfj) format("embedded-opentype"), url(/redesign/global/css/fonts/gotham-light.woff) format("woff");font-weight:300;font-style:normal;}@font-face{font-family:gotham-300-normal;src:url(/redesign/global/css/fonts/04F6D068D4A33A1DF.eot);src:local("?"), url(/redesign/global/css/fonts/04F6D068D4A33A1DF.eot?#hfj) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:gotham;src:local("?"), url(/redesign/global/css/fonts/F4671B5B0A865F73C.eot?#hfj) format("embedded-opentype"), url(/redesign/global/css/fonts/gotham-light-italic.woff) format("woff");font-weight:300;font-style:italic;}@font-face{font-family:gotham-300-italic;src:url(/redesign/global/css/fonts/F4671B5B0A865F73C.eot);src:local("?"), url(/redesign/global/css/fonts/F4671B5B0A865F73C.eot?#hfj) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:gotham;src:local("?"), url(/redesign/global/css/fonts/0E1C61EA7744BAF6E.eot?#hfj) format("embedded-opentype"), url(/redesign/global/css/fonts/gotham-book.woff) format("woff");font-weight:400;font-style:normal;}@font-face{font-family:gotham-400-normal;src:url(/redesign/global/css/fonts/0E1C61EA7744BAF6E.eot);src:local("?"), url(/redesign/global/css/fonts/0E1C61EA7744BAF6E.eot?#hfj) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:gotham;src:local("?"), url(/redesign/global/css/fonts/6DD66284BA5A9CFF6.eot?#hfj) format("embedded-opentype"), url(/redesign/global/css/fonts/gotham-book-italic.woff) format("woff");font-weight:400;font-style:italic;}@font-face{font-family:gotham-400-italic;src:url(/redesign/global/css/fonts/6DD66284BA5A9CFF6.eot);src:local("?"), url(/redesign/global/css/fonts/6DD66284BA5A9CFF6.eot?#hfj) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:gotham;src:local("?"), url(/redesign/global/css/fonts/140183092F34C88B5.eot?#hfj) format("embedded-opentype"), url(/redesign/global/css/fonts/gotham-medium.woff) format("woff");font-weight:500;font-style:normal;}@font-face{font-family:gotham-500-normal;src:url(/redesign/global/css/fonts/140183092F34C88B5.eot);src:local("?"), url(/redesign/global/css/fonts/140183092F34C88B5.eot?#hfj) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:gotham;src:local("?"), url(/redesign/global/css/fonts/A3C99C48DFF681102.eot?#hfj) format("embedded-opentype"), url(/redesign/global/css/fonts/gotham-medium-italic.woff) format("woff");font-weight:500;font-style:italic;}@font-face{font-family:gotham-500-italic;src:url(/redesign/global/css/fonts/A3C99C48DFF681102.eot);src:local("?"), url(/redesign/global/css/fonts/A3C99C48DFF681102.eot?#hfj) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:gotham;src:local("?"), url(/redesign/global/css/fonts/A3FE1652E9A9460E6.eot?#hfj) format("embedded-opentype"), url(/redesign/global/css/fonts/gotham-bold.woff) format("woff");font-weight:700;font-style:normal;}@font-face{font-family:gotham-700-normal;src:url(/redesign/global/css/fonts/A3FE1652E9A9460E6.eot);src:local("?"), url(/redesign/global/css/fonts/A3FE1652E9A9460E6.eot?#hfj) format("embedded-opentype");font-weight:normal;font-style:normal;}@font-face{font-family:gotham;src:local("?"), url(/redesign/global/css/fonts/9E86ED56F0272CCE6.eot?#hfj) format("embedded-opentype"), url(/redesign/global/css/fonts/gotham-bold-italic.woff) format("woff");font-weight:700;font-style:italic;}@font-face{font-family:gotham-700-italic;src:url(/redesign/global/css/fonts/9E86ED56F0272CCE6.eot);src:local("?"), url(/redesign/global/css/fonts/9E86ED56F0272CCE6.eot?#hfj) format("embedded-opentype");font-weight:normal;font-style:normal;}</style><style type="text/css">html,body,div,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre{margin:0;padding:0;border:0;}a{margin:0;padding:0;border:0;line-height:1.571428em;cursor:pointer;}code,del,dfn,em,img,q,dl,dt,dd,ol,ul,li{margin:0;padding:0;border:0;}abbr,acronym,address,area,b,bdo,big,blockquote,caption,center,cite,code,col,colgroup,dd{line-height:1.571428em;}del{line-height:1.571428em;text-decoration:line-through;}dfn{line-height:1.571428em;font-style:italic;}div,dl,dt,em,font,h3,h4,h5,h6,hr,i,ins,kbd,li,map,ol,p,pre,q,s,samp,small,span,strike,strong,sub,sup,table,tbody,td,tfoot,th,thead,tr,tt,u,ul{line-height:1.571428em;}body{color:#383838;font-family:gotham, helvetica, arial, sans-serif;font-size:14px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;margin:0;word-wrap:break-word;overflow-wrap:break-word;padding-right:1px;box-sizing:border-box;}a:link,a:visited{color:#047ac6;}a:hover,a:active{color:#2596de;}h1{font-family:gotham, helvetica, arial, sans-serif;font-weight:bold;font-size:1.5em;line-height:1.047619em;margin-bottom:0.4761em;margin-top:0.9523em;}h2{font-family:gotham, helvetica, arial, sans-serif;font-weight:bold;font-size:1.286em;line-height:1.222222em;margin-bottom:0.5556em;margin-top:1.111em;}h3{font-family:gotham, helvetica, arial, sans-serif;font-weight:bold;font-size:1em;margin-bottom:0.714285em;margin-top:1.4285em;}h4,h5,h6{font-family:gotham, helvetica, arial, sans-serif;font-weight:bold;}h4,h5,h6{font-size:1em;font-weight:bold;}div{font-family:gotham, helvetica, arial, sans-serif;font-size:14px;}p{margin-bottom:0.714285em;}img.en-media{margin-bottom:1.286em;max-width:100%;height:auto;}img.en-media[height="1"]{height:1px;}p+img,p+div img{margin-top:0.714285em;}div+img,div+div img{margin-top:0.857412em;}img+img,div+div img+img{margin-top:0;}ul,ol{list-style-position:outside;margin-top:0.2857em;margin-bottom:0.714285em;margin-left:2.7em;padding-left:0;}li ul,li ol{margin-bottom:0;margin-top:0;}p+ul,p+ol,h1+ul,h1+ol,h2+ul,h2+ol{margin-top:-0.428571em;}blockquote{border-left-color:#bfbfbf;border-left-style:solid;border-left-width:2px;margin-left:1.4285em;padding-left:0.714285em;margin-top:1.4285em;margin-bottom:1.4285em;}pre,code{font-family:Monaco, Courier, monospace;}cite{font-style:italic;}table{font-size:1em;}th,td{padding:0.2em 2em 0.2em 0;text-align:left;vertical-align:top;}button.en-ignore{margin-bottom:1em;}.highlight{border:1px solid #62eb92;background:#c9f2d0;}.Decrypted{background-color:#f7f7f7;padding:5px;}.Decrypted .Header{font-family:gotham, helvetica, arial, sans-serif;font-size:11px;padding-bottom:5px;color:#404040;}.Decrypted .Body{background-color:white;padding:5px;}.canvas-container{margin-bottom:10px;border:1px solid #cacaca;background:#fff url(/redesign/global/img/loading-spinner.gif) no-repeat center center;}::selection{background:#c9f2d0;}img[name="en-crypt"]{cursor:pointer;}</style><style type="text/css">::-moz-selection{background:#c9f2d0;}</style></head><body class="ennote" style="overflow-y: hidden;"><div>2018年8月22日 by Ron</div><div><br></div><div>官方地址</div><div><a href="https://ourpalm.github.io/ILRuntime/public/v1/guide/tutorial.html" target="_blank">https://ourpalm.github.io/ILRuntime/public/v1/guide/tutorial.html</a></div><div><br></div><div><span style="font-weight: bold;">代码分支:&nbsp;feature/Hotfix_test_RonMacPro_180823</span></div><div><span style="font-weight: bold;">我的测试分支的源码里,直接搜索&nbsp;</span></div><div><span style="color: rgb(106, 153, 85); font-weight: bold;">RonILRuntime</span></div><div><span style="caret-color: rgb(106, 153, 85); font-weight: bold;">就能快速找到对应的源码</span></div><div><span style="font-weight: bold;">然后,遇到一些奇怪的问题.我都总结在最后面.这个大家要注意一下</span></div><div><br></div><div><br></div><div><br></div><div>1, 首先要做的注意事项目</div><div>&nbsp;&nbsp; &nbsp;你需要将下列源码目录复制Unity工程的Assets目录：</div><div>&nbsp;&nbsp; &nbsp;Mono.Cecil.20</div><div>&nbsp;&nbsp; &nbsp;Mono.Cecil.Pdb</div><div>&nbsp;&nbsp; &nbsp;ILRuntime</div><div>&nbsp;&nbsp; &nbsp;</div><div>2, 如果是UnityEngine.dll 引用不正确,则需要手动指引一下</div><div><br></div><div>3, 如果要调试,则需要安装对应的插件(目测只有windows下才有)</div><div><br></div><div>4, 为什么需要向ILRuntime注册委托?</div><div>&nbsp;&nbsp; &nbsp;不一定对. 由于C#跟C++交互(底层会通过IL2CPP转成C++),而C#的委托是一个对象类型,C++那边无法直接识别,所以要先向</div><div>ILRuntime注册这个对象的桥梁,让运行时,C++能正确识别</div><div><br></div><div>注意事项:</div><div><span style="color: rgb(196, 60, 255);">&nbsp; &nbsp; A, 同一种类型的注册一次即可</span></div><div>&nbsp;&nbsp; &nbsp;delegate void SomeDelegate(int a, float b);</div><div>&nbsp;&nbsp; &nbsp;Action&lt;int, float&gt; act;</div><div>&nbsp; &nbsp;&nbsp;</div><div>&nbsp;&nbsp; &nbsp;上面2个只需要注册一个即可</div><div>&nbsp;&nbsp; &nbsp;appDomain.DelegateManager.RegisterMethodDelegate&lt;<span style="color: rgb(61, 156, 255);">int</span>, <span style="color: rgb(61, 156, 255);">float</span>&gt;();</div><div><br></div><div>&nbsp;&nbsp; &nbsp;</div><div><span style="color: rgb(196, 60, 255);">&nbsp; &nbsp; B,&nbsp;如果是带返回类型的委托，例如：</span></div><div>&nbsp;&nbsp; &nbsp;delegate bool SomeFunction(int a, float b);</div><div>&nbsp;&nbsp; &nbsp;Func&lt;<span style="color: rgb(61, 156, 255);">int</span>, <span style="color: rgb(61, 156, 255);">float</span>, <span style="color: rgb(61, 156, 255);">bool</span>&gt; act;</div><div>&nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; 则这样注册</div><div>&nbsp; &nbsp;&nbsp;appDomain.DelegateManager.RegisterFunctionDelegate&lt;<span style="color: rgb(61, 156, 255);">int</span>, <span style="color: rgb(61, 156, 255);">float</span>, <span style="color: rgb(61, 156, 255);">bool</span>&gt;();</div><div>&nbsp;&nbsp; &nbsp;</div><div><span style="color: rgb(196, 35, 251);">&nbsp; &nbsp; C, Action和Func的区别在于</span></div><div>&nbsp; &nbsp; Action就是定义一个没有返回的委托</div><div>&nbsp; &nbsp; 而Func定义是一个有返回值的委托</div><div><br></div><div><span style="color: rgb(196, 35, 251);">&nbsp; &nbsp; D, 如果是自己的函数,没有采用Func和Action的,则需要自己额外手动写</span></div><div>&nbsp; &nbsp; 例如我们在Hotfix.cs里面写的FairyGUI的委托.当出现自己的委托没有注册这个的时候.ILRuntime会自动提示你的</div><div>&nbsp; &nbsp; 核心原理是 它要帮你转成 Action/Func 这样的类别来做桥接(我的理解)</div><div><span style="color: rgb(86, 156, 214);">&nbsp;&nbsp; &nbsp;this</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">DelegateManager</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">RegisterDelegateConvertor</span><span style="color: rgb(212, 212, 212);">&lt;</span><span style="color: rgb(78, 201, 176);">EventCallback0</span><span style="color: rgb(212, 212, 212);">&gt;((</span><span style="color: rgb(156, 220, 254);">act</span><span style="color: rgb(212, 212, 212);">)</span> <span style="color: rgb(212, 212, 212);">=&gt;</span>
</div><div><span style="color: rgb(212, 212, 212);">&nbsp;&nbsp; &nbsp;{</span></div><div><span style="color: rgb(197, 134, 192);">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return</span> <span style="color: rgb(86, 156, 214);">new</span> <span style="color: rgb(78, 201, 176);">EventCallback0</span><span style="color: rgb(212, 212, 212);">(()</span> <span style="color: rgb(212, 212, 212);">=&gt;</span>
</div><div><span style="color: rgb(212, 212, 212);">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{</span></div><div><span style="color: rgb(212, 212, 212);">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;((</span><span style="color: rgb(78, 201, 176);">Action</span><span style="color: rgb(212, 212, 212);">)</span><span style="color: rgb(156, 220, 254);">act</span><span style="color: rgb(212, 212, 212);">)();</span></div><div><span style="color: rgb(212, 212, 212);">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;});</span></div><div><span style="color: rgb(212, 212, 212);">&nbsp;&nbsp; &nbsp;});</span></div><div>&nbsp; &nbsp; <span style="color: rgb(196, 35, 251);">E, 总结以上的, 官方给出建议,尽量使用Func/Action这2个万能的委托. 并且尽量不要做跨域委托调用</span></div><div><br></div><div><br></div><div><span style="color: rgb(196, 35, 251);">&nbsp; &nbsp; F, &nbsp;关于语法糖的委托测试. 在feature/Hotfix_test_RonMacPro_180823 分支下的 init.cs</span></div><div><span style="color: rgb(196, 35, 251);">&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;或者参考这里 &nbsp;</span><a href="https://www.jianshu.com/p/96526064ed38" style="color: rgb(196, 35, 251);" target="_blank">https://www.jianshu.com/p/96526064ed38</a></div><div>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;</div><div>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;// 我自己的测试没有参数的</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mc.UseDelegateNoneArg( <span style="color: rgb(196, 35, 251);">() </span>=&gt; {</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.TestRonFuc();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</div><div><br></div><div>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; // 测试1个参数的</div><div>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;mc.UseDelegate(<span style="color: rgb(196, 35, 251);">s</span> =&gt;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Log.Debug(s);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, "Hello!”);</div><div>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;</div><div>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 测试2个参数的</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mc.UseDelegateTwoArg( <span style="color: rgb(196, 35, 251);">(a, b)</span> =&gt;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.TestRonFucTwoArg(a, b);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, "Hello Two Arg", 0</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</div><div>&nbsp; &nbsp; &nbsp;&nbsp;</div><div>这里一个参数的(), &nbsp;s=&gt;, (a, b) =&gt; 都只是对应参数个数而已</div><div><br></div><div><br></div><div><span style="font-weight: bold;">==================第二章-跨域继承==================分割线==================</span></div><div><br></div><div>1, <span style="color: rgb(191, 65, 245);">如果dll中要继承主项目的类, 或者实现主工程的一个接口, 则需要做跨域继承(跨域绑定).</span></div><div>详情可以参考 feature/Hotfix_test_RonMacPro_180823 分支</div><div>文件 ILRonTest_ ClassInheritanceTest_Adaptor.cs</div><div><br></div><div>在这里一点要千万注意的, 如果你的要继承某个函数,一定要用<span style="color: rgb(191, 65, 245); font-weight: bold;">关键字override, 而非virtual, 如果用virtual</span></div><div>则会进2次这个函数, 找了很久, 但目前还尚未得知ILRuntime为什么这样</div><div><img src="./3fe7dd44-4321-4ee6-aa48-47ab8f928f11.png" name="3fe7dd44-4321-4ee6-aa48-47ab8f928f11" class="en-media"><br></div><div><br></div><div><br></div><div>另外有必要说一点,当你运行时,dll里面(hotfix层的),全都包在ILRuntime里面,相当于是这样一个形态</div><div>dll里所有东西,都包在ILRuntime里面, 然后Dll &lt;—&gt; &nbsp;ILRuntime &lt;—&gt; Unity 这样的一个交互方式.</div><div>在我的理解中,</div><div><br></div><div><img width="245" src="./8cd2fdd9-f86a-4a32-8aa4-6961ae5170f6.png" name="8cd2fdd9-f86a-4a32-8aa4-6961ae5170f6" class="en-media"></div><div><br></div><div><br></div><div><span style="color: rgb(255, 64, 255);">2, 尽量不要一个Adapter实现多个跨域继承.</span></div><div>如果是单个跨域继承的.则应该实现好这个接口(具体的代码可以看我的例子)</div><div><span style="color: rgb(86, 156, 214);">public</span> <span style="color: rgb(86, 156, 214);">override</span> <span style="color: rgb(78, 201, 176);">Type</span> <span style="color: rgb(156, 220, 254);">BaseCLRType</span>
</div><div><br></div><div>如果是一个Adapter要跨域继承多个的,则应该实现这个接口(具体代码看例子)</div><div><span style="color: rgb(86, 156, 214);">public</span> <span style="color: rgb(86, 156, 214);">override</span> <span style="color: rgb(78, 201, 176);">Type</span><span style="color: rgb(212, 212, 212);">[]</span> <span style="color: rgb(156, 220, 254);">BaseCLRTypes</span>
</div><div><br></div><div><br></div><div>2个接口照着写就行了</div><div><span style="color: rgb(86, 156, 214);">public</span> <span style="color: rgb(86, 156, 214);">override</span> <span style="color: rgb(78, 201, 176);">Type</span> <span style="color: rgb(156, 220, 254);">AdaptorType</span>
</div><div><span style="color: rgb(86, 156, 214);">public</span><span style="color: rgb(156, 220, 254);"> </span><span style="color: rgb(86, 156, 214);">override</span><span style="color: rgb(156, 220, 254);"> </span><span style="color: rgb(86, 156, 214);">object</span><span style="color: rgb(156, 220, 254);"> </span><span style="color: rgb(220, 220, 170);">CreateCLRInstance</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(78, 201, 176);">ILRuntime</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(78, 201, 176);">Runtime</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(78, 201, 176);">Enviorment</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(78, 201, 176);">AppDomain</span><span style="color: rgb(156, 220, 254);"> </span><span style="color: rgb(156, 220, 254);">appdomain</span><span style="color: rgb(212, 212, 212);">,</span><span style="color: rgb(156, 220, 254);"> </span><span style="color: rgb(78, 201, 176);">ILTypeInstance</span><span style="color: rgb(156, 220, 254);"> </span><span style="color: rgb(156, 220, 254);">instance</span><span style="color: rgb(212, 212, 212);">)</span><span style="color: rgb(156, 220, 254);">
</span></div><div><br></div><div><br></div><div><br></div><div><span style="color: rgb(255, 64, 255);">3, 这一步是要实现类Adaptor, 我看例子是直接把这个类嵌套在ClassInheritanceAdaptor</span></div><div><span style="color: rgb(86, 156, 214);">class</span> <span style="color: rgb(78, 201, 176);">Adaptor</span> <span style="color: rgb(212, 212, 212);">:</span> <span style="color: rgb(78, 201, 176);">ClassInheritanceTest</span><span style="color: rgb(212, 212, 212);">,</span> <span style="color: rgb(78, 201, 176);">CrossBindingAdaptorType</span></div><div>这个类基本copy就行了.</div><div>然后实现你要跨域的接口. 例如我例子中的这2个接口</div><div><span style="color: rgb(86, 156, 214);">public</span> <span style="color: rgb(86, 156, 214);">override</span> <span style="color: rgb(86, 156, 214);">void</span> <span style="color: rgb(220, 220, 170);">TestAbstract</span><span style="color: rgb(212, 212, 212);">()</span>
</div><div><span style="color: rgb(86, 156, 214);">public</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(86, 156, 214);">override</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(86, 156, 214);">void</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(220, 220, 170);">TestVirtual</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(86, 156, 214);">string</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">a</span><span style="color: rgb(212, 212, 212);">)</span><span style="color: rgb(212, 212, 212);">
</span></div><div><br></div><div><br></div><div><span style="color: rgb(255, 64, 255);">4, 当你把Adaptor做好之后, 就要在主工程里面做一个跨域继承的注册</span></div><div><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">LoadHotfixAssembly</span><span style="color: rgb(212, 212, 212);">();</span></div><div><span style="color: rgb(86, 156, 214);">#if</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">ILRuntime</span><span style="color: rgb(86, 156, 214);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(212, 212, 212);">
</span></div><div><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">RegisterCrossBindingAdaptor</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(86, 156, 214);">new</span><span style="color: rgb(86, 156, 214);"> </span><span style="color: rgb(78, 201, 176);">ClassInheritanceAdaptor</span><span style="color: rgb(212, 212, 212);">());</span><span style="color: rgb(86, 156, 214);">
</span></div><div><span style="color: rgb(86, 156, 214);">#endif&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div><br></div><div><span style="color: rgb(86, 156, 214);"># 主工程里面这样用</span></div><div><span style="color: rgb(86, 156, 214);">ClassInheritanceTest obj = Game.Hotfix.appDomain.Instantiate&lt;ClassInheritanceTest&gt;("ETHotfix.RonDerivedClass");</span></div><div><span style="color: rgb(106, 153, 85);">obj.TestAbstract();</span></div><div><span style="color: rgb(106, 153, 85);">obj.TestVirtual("Create 1111</span><span style="caret-color: rgb(106, 153, 85); color: rgb(106, 153, 85);">”</span><span style="color: rgb(106, 153, 85);">);</span></div><div><br></div><div><span style="color: rgb(106, 153, 85);"># dll里面这样用</span></div><div><span style="color: rgb(78, 201, 176);">RonDerivedClass</span><span style="color: rgb(106, 153, 85);"> </span><span style="color: rgb(156, 220, 254);">obj</span><span style="color: rgb(106, 153, 85);"> </span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(106, 153, 85);"> </span><span style="color: rgb(86, 156, 214);">new</span><span style="color: rgb(106, 153, 85);"> </span><span style="color: rgb(78, 201, 176);">RonDerivedClass</span><span style="color: rgb(212, 212, 212);">();</span><span style="color: rgb(106, 153, 85);">
</span></div><div><span style="color: rgb(156, 220, 254);">obj</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">TestAbstract</span><span style="color: rgb(212, 212, 212);">();</span></div><div><span style="color: rgb(156, 220, 254);">obj</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">TestVirtual</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"Hello world!"</span><span style="color: rgb(212, 212, 212);">);</span></div><div><br></div><div><br></div><div><br></div><div><br></div><div><span style="font-weight: bold;">===================第三章-ILRuntime中的反射--分割线===================</span></div><div><br></div><div><span style="color: rgb(255, 64, 255);">1, &nbsp;根据上面的ILRuntime和主工程的交互,主工程是无法识别ILRuntime里的东西,那么通过反射就能调用了(我之前基本没接触过反射这概念,遇到这个后,比较好理解了).</span></div><div><span style="color: rgb(255, 64, 255);">&nbsp; &nbsp; A,&nbsp;在主工程中,得到dll中的实例,并且通过反射调用他的某个方法</span></div><div><span style="color: rgb(255, 64, 255);">&nbsp; &nbsp; B, 并且在主工程里,通过</span><span style="color: rgb(78, 201, 176);">FieldInfo</span><span style="color: rgb(255, 64, 255);">的方式填充BPGameData实例的PlayTime属性.</span></div><div><span style="color: rgb(106, 153, 85);">// RonILRuntime 测试主工程获取dll中的对象</span></div><div><span style="color: rgb(78, 201, 176);">IMethod</span> <span style="color: rgb(156, 220, 254);">getBPGameDataMethod</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetType</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"ETHotfix.Init"</span><span style="color: rgb(212, 212, 212);">).</span><span style="color: rgb(220, 220, 170);">GetMethod</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"GetBpGameData"</span><span style="color: rgb(212, 212, 212);">,</span> <span style="color: rgb(181, 206, 168);">0</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><span style="color: rgb(86, 156, 214);">object</span> <span style="color: rgb(156, 220, 254);">bpGameDataObj</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Invoke</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(156, 220, 254);">getBPGameDataMethod</span><span style="color: rgb(212, 212, 212);">,</span> <span style="color: rgb(86, 156, 214);">null</span><span style="color: rgb(212, 212, 212);">,</span> <span style="color: rgb(86, 156, 214);">null</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><span style="color: rgb(156, 220, 254);">Log</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Debug</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"主工程层获取bpGameData ========&gt;"</span> <span style="color: rgb(212, 212, 212);">+</span> <span style="color: rgb(156, 220, 254);">bpGameDataObj</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetHashCode</span><span style="color: rgb(212, 212, 212);">());</span>
</div><div><br></div><div><span style="color: rgb(106, 153, 85);">// 然后调用这个对象的方法 SaveGameData</span></div><div><span style="color: rgb(78, 201, 176);">IType</span> <span style="color: rgb(156, 220, 254);">dataType</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">LoadedTypes</span><span style="color: rgb(212, 212, 212);">[</span><span style="color: rgb(206, 145, 120);">"ETHotfix.BPGameData"</span><span style="color: rgb(212, 212, 212);">];</span>
</div><div><span style="color: rgb(78, 201, 176);">Type</span> <span style="color: rgb(156, 220, 254);">dataT</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">dataType</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">ReflectionType</span><span style="color: rgb(212, 212, 212);">;</span>
</div><div><span style="color: rgb(78, 201, 176);">MethodInfo</span> <span style="color: rgb(156, 220, 254);">SaveGameDataFunc</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">dataT</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetMethod</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"SaveGameData"</span><span style="color: rgb(212, 212, 212);">,</span> <span style="color: rgb(181, 206, 168);">0</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><span style="color: rgb(156, 220, 254);">SaveGameDataFunc</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Invoke</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(156, 220, 254);">bpGameDataObj</span><span style="color: rgb(212, 212, 212);">,</span> <span style="color: rgb(86, 156, 214);">null</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><br></div><div><br></div><div><span style="color: rgb(106, 153, 85);">// // RonILRuntime 测试主工程获取dll中的对象 + 调用它带参数的某个方法</span></div><div><span style="color: rgb(78, 201, 176);">IMethod</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">getBPGameDataMethod</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetType</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"ETHotfix.Init"</span><span style="color: rgb(212, 212, 212);">).</span><span style="color: rgb(220, 220, 170);">GetMethod</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"GetBpGameData"</span><span style="color: rgb(212, 212, 212);">,</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(181, 206, 168);">0</span><span style="color: rgb(212, 212, 212);">);</span><span style="color: rgb(212, 212, 212);">
</span></div><div><span style="color: rgb(86, 156, 214);">object</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">bpGameDataObj</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Invoke</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(156, 220, 254);">getBPGameDataMethod</span><span style="color: rgb(212, 212, 212);">,</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(86, 156, 214);">null</span><span style="color: rgb(212, 212, 212);">,</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(86, 156, 214);">null</span><span style="color: rgb(212, 212, 212);">);</span><span style="color: rgb(212, 212, 212);">
</span></div><div><span style="color: rgb(78, 201, 176);">IType</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">dataType</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">LoadedTypes</span><span style="color: rgb(212, 212, 212);">[</span><span style="color: rgb(206, 145, 120);">"ETHotfix.BPGameData"</span><span style="color: rgb(212, 212, 212);">];</span><span style="color: rgb(212, 212, 212);">
</span></div><div><span style="color: rgb(78, 201, 176);">Type</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">dataT</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">dataType</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">ReflectionType</span><span style="color: rgb(212, 212, 212);">;</span><span style="color: rgb(212, 212, 212);">
</span></div><div><span style="color: rgb(78, 201, 176);">IMethod</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">imObj</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">dataType</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetMethod</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"SaveGameData"</span><span style="color: rgb(212, 212, 212);">,</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(181, 206, 168);">1</span><span style="color: rgb(212, 212, 212);">);</span><span style="color: rgb(212, 212, 212);">
</span></div><div><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Invoke</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(156, 220, 254);">imObj</span><span style="color: rgb(212, 212, 212);">,</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">bpGameDataObj</span><span style="color: rgb(212, 212, 212);">,</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(181, 206, 168);">5</span><span style="color: rgb(212, 212, 212);">);</span><span style="color: rgb(212, 212, 212);">
</span></div><div><br></div><div><span style="color: rgb(106, 153, 85);">// 用反射设置instance中的值</span></div><div><span style="color: rgb(78, 201, 176);">FieldInfo</span> <span style="color: rgb(156, 220, 254);">playTimeFieldInfo</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">dataT</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetField</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"playTime"</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><span style="color: rgb(86, 156, 214);">object</span> <span style="color: rgb(156, 220, 254);">val</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">playTimeFieldInfo</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetValue</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(156, 220, 254);">bpGameDataObj</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><span style="color: rgb(156, 220, 254);">Log</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Debug</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"得到dll中的bpGameData PlayTime的值 ======&gt;"</span> <span style="color: rgb(212, 212, 212);">+</span> <span style="color: rgb(156, 220, 254);">val</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><br></div><div><span style="color: rgb(156, 220, 254);">playTimeFieldInfo</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">SetValue</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(156, 220, 254);">bpGameDataObj</span><span style="color: rgb(212, 212, 212);">,</span> <span style="color: rgb(181, 206, 168);">7777</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><br></div><div><span style="color: rgb(156, 220, 254);">val</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">playTimeFieldInfo</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetValue</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(156, 220, 254);">bpGameDataObj</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><span style="color: rgb(156, 220, 254);">Log</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Debug</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"设置后的属性值 PlayTime的值 2222 ======&gt;"</span> <span style="color: rgb(212, 212, 212);">+</span> <span style="color: rgb(156, 220, 254);">val</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><br></div><div><br></div><div><span style="color: rgb(255, 64, 255);">2, 在主工程中,如果要创建dll中的对象,然后在调用它的某个方法. 那么应该这么做</span></div><div><span style="color: rgb(106, 153, 85);">// A, 主工程创建dll中的对象 + 调用它的某个方法</span></div><div><span style="color: rgb(78, 201, 176);">IType</span> <span style="color: rgb(156, 220, 254);">bpGameDataIType</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">LoadedTypes</span><span style="color: rgb(212, 212, 212);">[</span><span style="color: rgb(206, 145, 120);">"ETHotfix.BPGameData"</span><span style="color: rgb(212, 212, 212);">];</span>
</div><div><span style="color: rgb(78, 201, 176);">Type</span> <span style="color: rgb(156, 220, 254);">bpGameDataType</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">bpGameDataIType</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">ReflectionType</span><span style="color: rgb(212, 212, 212);">;</span>
</div><div><br></div><div><span style="color: rgb(156, 220, 254);">Log</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Debug</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"主工程调用dll的 创建对象之前.........."</span><span style="color: rgb(212, 212, 212);">);</span></div><div><span style="color: rgb(78, 201, 176);">ILTypeInstance</span> <span style="color: rgb(156, 220, 254);">bpGameDataObj</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Instantiate</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"ETHotfix.BPGameData"</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><span style="color: rgb(78, 201, 176);">MethodInfo</span> <span style="color: rgb(156, 220, 254);">mi</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">bpGameDataType</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetMethod</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"SaveGameData"</span><span style="color: rgb(212, 212, 212);">,</span> <span style="color: rgb(181, 206, 168);">0</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><span style="color: rgb(156, 220, 254);">mi</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Invoke</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(156, 220, 254);">bpGameDataObj</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">CLRInstance</span><span style="color: rgb(212, 212, 212);">,</span> <span style="color: rgb(86, 156, 214);">null</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><br></div><div><span style="color: rgb(106, 153, 85);">// B, 主工程创建dll中的对象 + 调用它的某个方法(带参数的)</span></div><div><span style="color: rgb(78, 201, 176);">IType</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">bpGameDataIType</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">LoadedTypes</span><span style="color: rgb(212, 212, 212);">[</span><span style="color: rgb(206, 145, 120);">"ETHotfix.BPGameData"</span><span style="color: rgb(212, 212, 212);">];</span><span style="color: rgb(212, 212, 212);">
</span></div><div><span style="color: rgb(78, 201, 176);">Type</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">bpGameDataType</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">bpGameDataIType</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">ReflectionType</span><span style="color: rgb(212, 212, 212);">;</span><span style="color: rgb(212, 212, 212);">
</span></div><div><span style="color: rgb(78, 201, 176);">ILTypeInstance</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">bpGameDataObj</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Instantiate</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"ETHotfix.BPGameData"</span><span style="color: rgb(212, 212, 212);">);</span><span style="color: rgb(212, 212, 212);">
</span></div><div><span style="color: rgb(78, 201, 176);">IMethod</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">im</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">bpGameDataIType</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetMethod</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"SaveGameData"</span><span style="color: rgb(212, 212, 212);">,</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(181, 206, 168);">1</span><span style="color: rgb(212, 212, 212);">);</span><span style="color: rgb(212, 212, 212);">
</span></div><div><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Hotfix</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">appDomain</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Invoke</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(156, 220, 254);">im</span><span style="color: rgb(212, 212, 212);">,</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(156, 220, 254);">bpGameDataObj</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">CLRInstance</span><span style="color: rgb(212, 212, 212);">,</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(181, 206, 168);">5</span><span style="color: rgb(212, 212, 212);">);</span><span style="color: rgb(212, 212, 212);">
</span></div><div><br></div><div><br></div><div><span style="color: rgb(255, 64, 255);">3, &nbsp;在dll中, 实例主工程中的某个类型.然后在调用</span></div><div><span style="color: rgb(106, 153, 85);">// RonILRuntime 在这里用反射创建主工程的东西. 然后直接调用(这个是不带参数的)</span></div><div><span style="color: rgb(78, 201, 176);">Type</span> <span style="color: rgb(156, 220, 254);">myClassT</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">Type</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">GetType</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"ETModel.MyClass"</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><span style="color: rgb(86, 156, 214);">object</span> <span style="color: rgb(156, 220, 254);">newObj</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">Activator</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">CreateInstance</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(156, 220, 254);">myClassT</span><span style="color: rgb(212, 212, 212);">);</span>
</div><div><span style="color: rgb(78, 201, 176);">MyClass</span> <span style="color: rgb(156, 220, 254);">myClassObj</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(78, 201, 176);">MyClass</span><span style="color: rgb(212, 212, 212);">)</span><span style="color: rgb(156, 220, 254);">newObj</span><span style="color: rgb(212, 212, 212);">;</span>
</div><div><span style="color: rgb(156, 220, 254);">myClassObj</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Method</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"WirteLog</span><span style="caret-color: rgb(206, 145, 120); color: rgb(206, 145, 120);">”</span><span style="color: rgb(212, 212, 212);">);</span></div><div><br></div><div><span style="color: rgb(106, 153, 85);">// 带参数的(其实dll中调用主工程中的,是可以不用通过反射的.</span></div><div><span style="caret-color: rgb(106, 153, 85); color: rgb(255, 64, 255);">我问了ILR的技术人员,他的意思是ILR在哪个时候,能得到主工程里的信息.所以可以直接这样调用</span></div><div><span style="color: rgb(156, 220, 254);">myClassObj</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">WirteLogWithArg</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">"不用通过反射直接调用"</span><span style="color: rgb(212, 212, 212);">);</span></div><div><br></div><div><br></div><div><span style="color: rgb(255, 64, 255);">4, &nbsp;获取主工程的中某个对象</span></div><div># 直接在hotfix工程里面定义一个这样的</div><div><span style="color: rgb(86, 156, 214);">public</span><span style="color: rgb(212, 212, 212);"> </span><span style="color: rgb(78, 201, 176);">ETModel</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(78, 201, 176);">Scene&nbsp;</span><span style="color: rgb(156, 220, 254);">ModelScene;</span></div><div><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Scene</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">ModelScene</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">ETModel</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Game</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(156, 220, 254);">Scene</span><span style="color: rgb(212, 212, 212);">;</span>
</div><div><br></div><div><span style="caret-color: rgb(212, 212, 212);">为什么可以这样做, 是因为ILR已经识别主工程的东西,所以能直接赋值到dll里.</span></div><div><br></div><div><br></div><div><span style="color: rgb(255, 64, 255);">5, &nbsp;限制: 在Unity主工程中不能通过new T()的方式来创建热更工程中的类型实例</span></div><div>这个是需要通过CLR重定向来做(因为反射没办法做,为什么? 我还没想明白).</div><div><br></div><div><span style="color: rgb(4, 51, 255);">因为那个时候,主工程无法直接dll中的类型,所以不能用new T(). 得通过反射来创建</span></div><div><span style="color: rgb(4, 51, 255);">类似这样</span></div><div><span style="font-size: 13px; color: rgb(147, 161, 161); font-family: Menlo;">IObject obj1=(IObject)Activator.CreateInstance(System.Type.GetType ("ActivatorCreateInstance.ClassExam"));</span></div><div><br></div><div><br></div><div>6, 暂时不知道怎么获取静态对象</div><div><br></div><div><br></div><div><br></div><div><br></div><div>===================第四章-CLR--分割线===================</div><div>CLR重定向</div><div>重定向的目的是为了有一些无法直接通过反射来实现的东西,就需要这个了(譬如 new T()),&nbsp;</div><div>它的原理是ILR挟持了这个方法,当你调用的时候,它会转到去你注册的那个方法里.</div><div>下面以UnityEngine.Debug.Log()为例子</div><div>在ILRuntimeCLRBinding.cs里有一个GenerateCLRBinding函数</div><div>里面就有一行代码是&nbsp;</div><div><span style="color: rgb(156, 220, 254);">types</span><span style="color: rgb(212, 212, 212);">.</span><span style="color: rgb(220, 220, 170);">Add</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(86, 156, 214);">typeof</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(78, 201, 176);">Debug</span><span style="color: rgb(212, 212, 212);">));</span></div><div><br></div><div>做CLR的2个目的是:</div><div><span style="color: rgb(255, 64, 255); font-weight: bold;">1, 为了防止在iOS被剪裁</span></div><div><span style="color: rgb(255, 64, 255); font-weight: bold;">2, 可以少用反射,和GC Alloc. 这样能提高效率</span></div><div><br></div><div>不过这里要注意的是,真正的在项目里做CLR的时候.不是这样的.</div><div>是点击这个来分析的</div><div><img src="./3da8b8e4-6565-41b0-a8ad-290af4ae44ac.png" name="3da8b8e4-6565-41b0-a8ad-290af4ae44ac" class="en-media"><br></div><div>他的原理是加载Dll, 然后看dll中用到了那些函数. 譬如UnityEngine.Debug.Log这样的函数. 他就会去做CLR</div><div><br></div><div><br></div><div>我github的最新ET版测试代码(CLR分析的时候.依然会有Bug)</div><div><a href="mailto:git@github.com" target="_blank">git@github.com</a>:Ron3/ET.git</div><div>这条分支(已经在Mac上成功执行)</div><div><a href="https://github.com/Ron3/ET/tree/feature/ron_test_clr_180905" style="box-sizing: border-box; background-color: rgb(234, 245, 255); font-size: 12px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; outline-width: 0px; max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: top; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(3, 102, 214); font-family: SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-stretch: normal; font-variant-caps: normal; line-height: normal; text-decoration: underline;" target="_blank">feature/ron_test_clr_180905</a><span style="font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgba(27, 31, 35, 0.498039); font-family: -apple-system, system-ui, &quot;Segoe UI&quot;, Helvetica, Arial, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">&nbsp;</span></div><div><br></div><div><br></div><div><br></div><div><br></div></body></html>